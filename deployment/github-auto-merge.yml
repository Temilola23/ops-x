# GitHub Action: Auto-merge PRs when approved OR when all checks pass
# Copy this to .github/workflows/auto-merge.yml in generated repos
# 
# Merge triggers:
# 1. CodeRabbit/human/bot approval + all checks pass
# 2. All checks pass (no approval needed)

name: Auto-merge Approved PRs

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Check if CodeRabbit approved
        id: check_approval
        uses: actions/github-script@v7
        with:
          script: |
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            const coderabbitApproved = reviews.some(review => 
              review.user.login.includes('coderabbit') && 
              review.state === 'APPROVED'
            );
            
            const humanApproved = reviews.some(review => 
              review.user.type === 'User' && 
              review.state === 'APPROVED'
            );
            
            console.log(`CodeRabbit approved: ${coderabbitApproved}`);
            console.log(`Human approved: ${humanApproved}`);
            
            // Auto-merge if CodeRabbit approved OR human approved
            return coderabbitApproved || humanApproved;
      
      - name: Check if all checks passed
        id: check_status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });
            
            const allPassed = statuses.state === 'success';
            console.log(`All checks passed: ${allPassed}`);
            return allPassed;
      
      - name: Auto-merge PR
        if: |
          (steps.check_approval.outputs.result == 'true' && steps.check_status.outputs.result == 'true') ||
          steps.check_status.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const approved = ${{ steps.check_approval.outputs.result }};
            const allChecksPassed = ${{ steps.check_status.outputs.result }};
            
            let mergeReason = '';
            if (approved && allChecksPassed) {
              mergeReason = 'Auto-merged by OPS-X: approved + all checks passed';
            } else if (allChecksPassed) {
              mergeReason = 'Auto-merged by OPS-X: all checks passed';
            }
            
            console.log(`Merge reason: ${mergeReason}`);
            
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              merge_method: 'squash',
              commit_title: `${context.payload.pull_request.title} (#${context.payload.pull_request.number})`,
              commit_message: mergeReason
            });
            
            console.log('âœ… PR auto-merged successfully!');

